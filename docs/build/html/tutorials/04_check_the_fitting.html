<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>04_check_the_fitting &mdash; pigeon_feather 0.9 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=049aceee"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../_static/copybutton.js?v=f281be69"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="05_plot_the_results" href="05_plot_the_results.html" />
    <link rel="prev" title="03_calculate_PFs" href="03_calculate_PFs.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            pigeon_feather
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../documentation.html">Documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../tutorial.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="00_ecdhfr_showcase.html">00_Showcase ecDHFR: a FEATHER walkthrough</a></li>
<li class="toctree-l2"><a class="reference internal" href="01_load_data.html">01_load_data</a></li>
<li class="toctree-l2"><a class="reference internal" href="02_peptide_level_analysis.html">02_peptide_level_analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="03_calculate_PFs.html">03_calculate_PFs</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">04_check_the_fitting</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#envelope-check">envelope check</a></li>
<li class="toctree-l3"><a class="reference internal" href="#uptake-check">uptake check</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="05_plot_the_results.html">05_plot_the_results</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">pigeon_feather</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../tutorial.html">Tutorials</a></li>
      <li class="breadcrumb-item active">04_check_the_fitting</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/tutorials/04_check_the_fitting.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="04_check_the_fitting">
<h1>04_check_the_fitting<a class="headerlink" href="#04_check_the_fitting" title="Link to this heading"></a></h1>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pigeon_feather.data</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pigeon_feather.plot</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pigeon_feather.hxio</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pigeon_feather.spectra</span> <span class="kn">import</span> <span class="o">*</span>


<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">datetime</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Determination of memory status is not supported on this
 platform, measuring for memoryleaks will never fail
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load the pickle file we saved in the previous notebook</span>


<span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">today</span> <span class="o">=</span> <span class="s2">&quot;20240722&quot;</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;./data/hdxms_data_raw_</span><span class="si">{</span><span class="n">today</span><span class="si">}</span><span class="s2">.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">hdxms_data_list</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>


<span class="c1"># back exchange correction for peptides with experimental full deuteration data based its closest match in the database</span>
<span class="n">tools</span><span class="o">.</span><span class="n">backexchange_correction</span><span class="p">(</span><span class="n">hdxms_data_list</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Number of peptides with experimental max_d: 358
Number of peptides with no experimental max_d: 12
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># make folders for results</span>

<span class="n">today_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="c1"># today_date = &#39;20240722&#39;</span>
<span class="n">results_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ecDHFR_results_</span><span class="si">{</span><span class="n">today_date</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">results_path</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">results_path</span><span class="p">)</span>


<span class="n">out_path</span> <span class="o">=</span> <span class="s2">&quot;./data/PF_input_20240722&quot;</span>
</pre></div>
</div>
</div>
<p>Create an <code class="docutils literal notranslate"><span class="pre">Analysis</span></code> object and load the results. <strong>Note:</strong> The temperature and pH are crucial for calculating the intrinsic exchange rates, so make sure to input the correct values. The chunk size and chunk number can be altered by the user. In this tutorial, they were automatically determined by a helper function.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pigeon_feather.analysis</span> <span class="kn">import</span> <span class="n">Analysis</span><span class="p">,</span> <span class="n">get_index_offset</span>
<span class="kn">from</span> <span class="nn">pigeon_feather.tools</span> <span class="kn">import</span> <span class="n">optimal_chunks</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">RUN_NUM</span> <span class="o">=</span> <span class="mi">3</span>

<span class="n">apo_states</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">state</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">hdxms_data_list</span>
    <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">states</span>
    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">state_name</span> <span class="o">==</span> <span class="s2">&quot;APO&quot;</span>
<span class="p">]</span>

<span class="n">tri_states</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">state</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">hdxms_data_list</span>
    <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">states</span>
    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">state_name</span> <span class="o">==</span> <span class="s2">&quot;TRI&quot;</span>
<span class="p">]</span>

<span class="n">ana_apo_1</span> <span class="o">=</span> <span class="n">Analysis</span><span class="p">(</span><span class="n">apo_states</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">293.0</span><span class="p">,</span> <span class="n">pH</span><span class="o">=</span><span class="mf">7.0</span><span class="p">)</span>

<span class="n">chunk_num</span><span class="p">,</span> <span class="n">chunk_size</span> <span class="o">=</span> <span class="n">optimal_chunks</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ana_apo_1</span><span class="o">.</span><span class="n">protein_sequence</span><span class="p">))</span>
<span class="n">ana_apo_1</span><span class="o">.</span><span class="n">load_bayesian_hdx_oupt_chunks</span><span class="p">(</span>
    <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">,</span>
    <span class="n">chunk_num</span><span class="o">=</span><span class="n">chunk_num</span><span class="p">,</span>
    <span class="n">state_name</span><span class="o">=</span><span class="s2">&quot;APO&quot;</span><span class="p">,</span>
    <span class="n">run_num</span><span class="o">=</span><span class="n">RUN_NUM</span><span class="p">,</span>
    <span class="n">N</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
    <span class="n">bayesian_hdx_data_folder</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">out_path</span><span class="si">}</span><span class="s2">/bayesian_hdx_output_chunks&quot;</span><span class="p">,</span>
<span class="p">)</span>


<span class="n">ana_tri_1</span> <span class="o">=</span> <span class="n">Analysis</span><span class="p">(</span><span class="n">tri_states</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">293.0</span><span class="p">,</span> <span class="n">pH</span><span class="o">=</span><span class="mf">7.0</span><span class="p">)</span>

<span class="n">ana_tri_1</span><span class="o">.</span><span class="n">load_bayesian_hdx_oupt_chunks</span><span class="p">(</span>
    <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">,</span>
    <span class="n">chunk_num</span><span class="o">=</span><span class="n">chunk_num</span><span class="p">,</span>
    <span class="n">state_name</span><span class="o">=</span><span class="s2">&quot;TRI&quot;</span><span class="p">,</span>
    <span class="n">run_num</span><span class="o">=</span><span class="n">RUN_NUM</span><span class="p">,</span>
    <span class="n">N</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
    <span class="n">bayesian_hdx_data_folder</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">out_path</span><span class="si">}</span><span class="s2">/bayesian_hdx_output_chunks&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>two fitting check functions are available: 1. centroid level fitting check 2. isotopic mass envelope fitting check.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pigeon_feather.analysis</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">check_fitted_isotope_envelope</span><span class="p">,</span>
    <span class="n">check_fitted_peptide_uptake</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<section id="envelope-check">
<h2>envelope check<a class="headerlink" href="#envelope-check" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">check_state_name</span> <span class="o">=</span> <span class="s2">&quot;APO&quot;</span>
<span class="n">check_ana_obj</span> <span class="o">=</span> <span class="n">ana_apo_1</span>


<span class="n">all_peps</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">pep</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">hdxms_data_list</span>
    <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">states</span>
    <span class="k">for</span> <span class="n">pep</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">peptides</span>
    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">state_name</span> <span class="o">==</span> <span class="n">check_state_name</span> <span class="ow">and</span> <span class="n">pep</span><span class="o">.</span><span class="n">note</span> <span class="ow">is</span> <span class="kc">None</span>
<span class="p">]</span>
<span class="n">all_tps</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tp</span>
    <span class="k">for</span> <span class="n">pep</span> <span class="ow">in</span> <span class="n">all_peps</span>
    <span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="n">pep</span><span class="o">.</span><span class="n">timepoints</span>
    <span class="k">if</span> <span class="n">pep</span><span class="o">.</span><span class="n">get_timepoint</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tp</span><span class="o">.</span><span class="n">deut_time</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="ow">and</span> <span class="n">tp</span><span class="o">.</span><span class="n">deut_time</span> <span class="o">!=</span> <span class="mi">0</span>
<span class="p">]</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">envelope_errors</span> <span class="o">=</span> <span class="p">[(</span><span class="n">check_fitted_isotope_envelope</span><span class="p">(</span><span class="n">ana_apo_1</span><span class="p">,</span> <span class="n">tp</span><span class="p">),</span> <span class="n">tp</span><span class="p">)</span> <span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="n">all_tps</span><span class="p">]</span>
<span class="n">envelope_errors</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">envelope_errors</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># you can plot the fitted isotope envelope and the experimental data</span>
<span class="n">check_fitted_isotope_envelope</span><span class="p">(</span><span class="n">check_ana_obj</span><span class="p">,</span> <span class="n">envelope_errors</span><span class="p">[</span><span class="mi">300</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">if_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0.18336607065124264
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_04_check_the_fitting_10_1.png" src="../_images/tutorials_04_check_the_fitting_10_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">envelope_errors</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Sum AE&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Count&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0, 0.5, &#39;Count&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_04_check_the_fitting_11_1.png" src="../_images/tutorials_04_check_the_fitting_11_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><span></span><span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">envelope_errors</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">envelope_errors</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0.3669856716168908
0.39744791298433696
</pre></div></div>
</div>
</section>
<section id="uptake-check">
<h2>uptake check<a class="headerlink" href="#uptake-check" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pigeon_feather.analysis</span> <span class="kn">import</span> <span class="n">check_fitted_peptide_uptake</span>


<span class="n">all_idfs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">pep</span><span class="o">.</span><span class="n">identifier</span> <span class="k">for</span> <span class="n">pep</span> <span class="ow">in</span> <span class="n">all_peps</span><span class="p">]))</span>


<span class="k">def</span> <span class="nf">extract_numbers</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="n">numbers</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(-?\d+)-(-?\d+)&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">numbers</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>


<span class="n">all_idfs</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">extract_numbers</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">uptake_errors</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">all_peps_grouped</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">group_by_attributes</span><span class="p">(</span>
    <span class="n">all_peps</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;protein_state.state_name&quot;</span><span class="p">,</span> <span class="s2">&quot;identifier&quot;</span><span class="p">]</span>
<span class="p">)</span>

<span class="k">for</span> <span class="n">idf</span> <span class="ow">in</span> <span class="n">all_idfs</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">idf_peps</span> <span class="o">=</span> <span class="n">all_peps_grouped</span><span class="p">[(</span><span class="n">check_state_name</span><span class="p">,</span> <span class="n">idf</span><span class="p">)]</span>
        <span class="n">avg_pep</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">average_peptides</span><span class="p">(</span><span class="n">idf_peps</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">check_fitted_peptide_uptake</span><span class="p">(</span>
            <span class="n">check_ana_obj</span><span class="p">,</span> <span class="n">hdxms_data_list</span><span class="p">,</span> <span class="n">avg_pep</span><span class="p">,</span> <span class="n">state_name</span><span class="o">=</span><span class="n">check_state_name</span>
        <span class="p">)</span>
        <span class="n">uptake_errors</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">result</span><span class="p">,</span> <span class="n">avg_pep</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">idf</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>


<span class="n">uptake_errors_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">uptake_errors</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>


<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">))</span>

<span class="c1"># # Plotting with complementary colors</span>
<span class="c1"># sns.histplot([x[0] for x in envelope_errors], bins=20, kde=True, ax=axes[0], color=&quot;#FF6347&quot;)</span>
<span class="c1"># sns.histplot(uptake_errors_array, bins=20, kde=True, ax=axes[1], color=&quot;#4682B4&quot;)</span>


<span class="n">color_1</span> <span class="o">=</span> <span class="s2">&quot;#53b1b1&quot;</span>  <span class="c1"># A standard blue color</span>
<span class="n">color_2</span> <span class="o">=</span> <span class="s2">&quot;#f6c624&quot;</span>  <span class="c1"># A teal color</span>

<span class="c1"># Plotting with chosen colors</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">envelope_errors</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color_1</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">uptake_errors_array</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color_2</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Sum AE&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Da/peptide length&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_04_check_the_fitting_16_0.png" src="../_images/tutorials_04_check_the_fitting_16_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pigeon_feather.analysis</span> <span class="kn">import</span> <span class="n">get_index_offset</span>
<span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="kn">import</span> <span class="n">LogLocator</span>


<span class="n">check_ana_obj</span> <span class="o">=</span> <span class="n">ana_apo_1</span>
<span class="n">index_offset</span> <span class="o">=</span> <span class="n">get_index_offset</span><span class="p">(</span><span class="n">check_ana_obj</span><span class="p">,</span> <span class="s1">&#39;./data/6XG5_TRI.pdb&#39;</span><span class="p">)</span>

<span class="n">uptake_errors</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">uptake_errors</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">num_subplots_per_figure</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">uptake_errors</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="c1"># num_subplots_per_figure = 250</span>
<span class="n">num_figures</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_idfs</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_subplots_per_figure</span><span class="p">)</span>


<span class="k">for</span> <span class="n">fig_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_figures</span><span class="p">):</span>
    <span class="c1"># Select the subset of errors for the current figure</span>
    <span class="n">selected_uptake_errors</span> <span class="o">=</span> <span class="n">uptake_errors</span><span class="p">[</span><span class="n">fig_index</span> <span class="o">*</span> <span class="n">num_subplots_per_figure</span><span class="p">:(</span><span class="n">fig_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">num_subplots_per_figure</span><span class="p">]</span>
    <span class="n">num_col</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_uptake_errors</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">num_col</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">num_col</span><span class="p">))</span>  <span class="c1"># Adjust subplot size as needed</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">error_tuple</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">selected_uptake_errors</span><span class="p">):</span>


        <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span> <span class="o">//</span> <span class="mi">5</span><span class="p">,</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">5</span><span class="p">]</span>


        <span class="c1"># Unpack error information</span>
        <span class="n">peptide_data</span> <span class="o">=</span> <span class="n">error_tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>


        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">peptide_data</span><span class="o">.</span><span class="n">max_d</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="n">check_fitted_peptide_uptake</span><span class="p">(</span>
            <span class="n">check_ana_obj</span><span class="p">,</span>
            <span class="n">hdxms_data_list</span><span class="p">,</span>
            <span class="n">peptide_data</span><span class="p">,</span>
            <span class="n">if_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">state_name</span><span class="o">=</span><span class="n">check_state_name</span><span class="p">,</span>
            <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span>
        <span class="p">)</span>

        <span class="c1">#Retrieve and format the peptide identifier</span>
        <span class="n">idf</span> <span class="o">=</span> <span class="n">peptide_data</span><span class="o">.</span><span class="n">identifier</span>
        <span class="n">idf_start</span><span class="p">,</span> <span class="n">idf_end</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(-?\d+)-(-?\d+)&quot;</span><span class="p">,</span> <span class="n">idf</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">())</span>
        <span class="n">idf_seq</span> <span class="o">=</span> <span class="n">idf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idf_start</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">index_offset</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">idf_end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">index_offset</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">idf_seq</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mf">1e1</span><span class="p">,</span> <span class="mf">1e5</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">LogLocator</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">numticks</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>

        <span class="c1"># y_max = ax.get_ylim()[1]</span>
        <span class="c1"># ax.set_ylim(-0.5, y_max + 1)</span>
        <span class="n">pep</span> <span class="o">=</span> <span class="n">error_tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">y_max</span> <span class="o">=</span> <span class="n">pep</span><span class="o">.</span><span class="n">theo_max_d</span><span class="o">/</span><span class="n">check_ana_obj</span><span class="o">.</span><span class="n">saturation</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>

        <span class="c1"># light gray dotted line at max deuteration</span>


        <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
        <span class="n">new_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">label</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span> <span class="k">if</span> <span class="n">label</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()]</span>
        <span class="n">new_handles</span> <span class="o">=</span> <span class="p">[</span><span class="n">handle</span> <span class="k">for</span> <span class="n">handle</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">handles</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span> <span class="k">if</span> <span class="n">label</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">new_handles</span><span class="p">,</span> <span class="n">new_labels</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;replicate&#39;</span><span class="p">,</span> <span class="n">title_fontsize</span><span class="o">=</span><span class="s1">&#39;small&#39;</span><span class="p">)</span>

    <span class="c1"># Layout adjustment and save</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">results_path</span><span class="si">}</span><span class="s2">/ecDHFR_uptake_errors_</span><span class="si">{</span><span class="n">check_state_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">fig_index</span><span class="si">}</span><span class="s2">.pdf&quot;</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<p>If the fitting is poor, do not proceed. Check the parameters in the sampling to ensure they agree with the experimental conditions. You may also need to remove outlier peptides and rerun the sampling. An outlier might be a peptide that exchanges a lot while its neighbors barely exchange (examples in the tutorial dataset: 78-92 VDEAIAACGDVPEIM, 75-78 VKSV).</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="03_calculate_PFs.html" class="btn btn-neutral float-left" title="03_calculate_PFs" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="05_plot_the_results.html" class="btn btn-neutral float-right" title="05_plot_the_results" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, glasgowlab.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>