<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>00_Showcase ecDHFR: a FEATHER walkthrough &mdash; pigeon_feather 0.9 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css?v=2aa19091" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=049aceee"></script>
        <script src="../_static/doctools.js?v=9a2dae69"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../_static/copybutton.js?v=f281be69"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="01_load_data" href="01_load_data.html" />
    <link rel="prev" title="Tutorials" href="../tutorial.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            pigeon_feather
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../documentation.html">Documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../tutorial.html">Tutorials</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">00_Showcase ecDHFR: a FEATHER walkthrough</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#import">import</a></li>
<li class="toctree-l3"><a class="reference internal" href="#load-the-data">load the data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#back-exchange-correction">back exchange correction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#plot-uptake-plots">plot uptake plots</a></li>
<li class="toctree-l3"><a class="reference internal" href="#peptide-subtraction">peptide subtraction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#inputs-for-MCMC-sampling">inputs for MCMC sampling</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run-the-sampling">run the sampling</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Analysis">Analysis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Fitting-check">Fitting check</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#envelope-check">envelope check</a></li>
<li class="toctree-l4"><a class="reference internal" href="#uptake-check">uptake check</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#barplot-of-the-kex">barplot of the kex</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="01_load_data.html">01_load_data</a></li>
<li class="toctree-l2"><a class="reference internal" href="02_peptide_level_analysis.html">02_peptide_level_analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="03_calculate_PFs.html">03_calculate_PFs</a></li>
<li class="toctree-l2"><a class="reference internal" href="04_check_the_fitting.html">04_check_the_fitting</a></li>
<li class="toctree-l2"><a class="reference internal" href="05_plot_the_results.html">05_plot_the_results</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">pigeon_feather</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../tutorial.html">Tutorials</a></li>
      <li class="breadcrumb-item active">00_Showcase ecDHFR: a FEATHER walkthrough</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/tutorials/00_ecdhfr_showcase.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="00_Showcase-ecDHFR:-a-FEATHER-walkthrough">
<h1>00_Showcase ecDHFR: a FEATHER walkthrough<a class="headerlink" href="#00_Showcase-ecDHFR:-a-FEATHER-walkthrough" title="Link to this heading"></a></h1>
<p>The tutorial dataset can be downloaded from <a class="reference external" href="https://figshare.com/ndownloader/files/48153751">this link</a>.</p>
<section id="import">
<h2>import<a class="headerlink" href="#import" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pigeon_feather.data</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pigeon_feather.plot</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pigeon_feather.hxio</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pigeon_feather.spectra</span> <span class="kn">import</span> <span class="o">*</span>


<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># make folders for results</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">out_path</span> <span class="o">=</span> <span class="s2">&quot;./data/bayesian_hdx_input_20240722&quot;</span>

<span class="n">today_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="c1"># today_date = &#39;20240722&#39;</span>
<span class="n">results_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;ecDHFR_results_</span><span class="si">{</span><span class="n">today_date</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">results_path</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">results_path</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
</section>
<section id="load-the-data">
<h2>load the data<a class="headerlink" href="#load-the-data" title="Link to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tables</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;./data/ecDHFR_tutorial.csv&#39;</span><span class="p">]</span>

<span class="n">ranges</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;./data/rangeslist.csv&#39;</span><span class="p">]</span>


<span class="n">raw_spectra_paths</span> <span class="o">=</span> <span class="p">[</span>
    <span class="sa">f</span><span class="s2">&quot;./data/SpecExport/&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">protein_sequence</span> <span class="o">=</span> <span class="s2">&quot;MTGHHHHHHENLYFQSISLIAALAVDRVIGMENAMPWNLPADLAWFKRNTLDKPVIMGRHTWESIGRPLPGRKNIILSSQPGTDDRVTWVKSVDEAIAACGDVPEIMVIGGGRVYEQFLPKAQKLYLTHIDAEVEGDTHFPDYEPDDWESVFSEFHDADAQNSHSYCFEILERR&quot;</span>

<span class="c1"># load the data</span>
<span class="n">hdxms_data_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tables</span><span class="p">)):</span>
    <span class="c1"># for i in [4]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">tables</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>


    <span class="c1"># read the data and clean it</span>
    <span class="n">cleaned</span> <span class="o">=</span> <span class="n">read_hdx_tables</span><span class="p">([</span><span class="n">tables</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="p">[</span><span class="n">ranges</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">states_subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;APO&#39;</span><span class="p">,</span><span class="s1">&#39;TRI&#39;</span><span class="p">])</span>

    <span class="c1"># convert the cleaned data to hdxms data object</span>
    <span class="n">hdxms_data</span> <span class="o">=</span> <span class="n">load_dataframe_to_hdxmsdata</span><span class="p">(</span>
        <span class="n">cleaned</span><span class="p">,</span>
        <span class="n">n_fastamides</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">protein_sequence</span><span class="o">=</span><span class="n">protein_sequence</span><span class="p">,</span>
        <span class="n">fulld_approx</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">saturation</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># load the raw ms data to the hdxms data object</span>
    <span class="n">load_raw_ms_to_hdxms_data</span><span class="p">(</span>
        <span class="n">hdxms_data</span><span class="p">,</span>
        <span class="n">raw_spectra_paths</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="n">hdxms_data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hdxms_data</span><span class="p">)</span>
<br/><br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
./data/ecDHFR_tutorial.csv
rangeslist included !
Removed 0 peptides from state APO due to missing raw MS data.
Removed 70 peptides from state APO due to high back exchange.
Removed 2 peptides from state TRI due to missing raw MS data.
Removed 70 peptides from state TRI due to high back exchange.
Done loading raw MS data.
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hdxms_data_list</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&lt;pigeon_feather.data.HDXMSData at 0x7f6ccdb68fd0&gt;]
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># save the raw data as a pickle file</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">today</span> <span class="o">=</span> <span class="s2">&quot;20240722&quot;</span>

<span class="c1"># with open(f&quot;./data/hdxms_data_raw_{today}.pkl&quot;, &quot;wb&quot;) as f:</span>
<span class="c1">#     pickle.dump(hdxms_data_list, f)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;./data/hdxms_data_raw_</span><span class="si">{</span><span class="n">today</span><span class="si">}</span><span class="s2">.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">hdxms_data_list</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pigeon_feather.hxio</span> <span class="kn">import</span> <span class="n">get_all_statics_info</span>

<span class="n">get_all_statics_info</span><span class="p">(</span><span class="n">hdxms_data_list</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
============================================================
                    HDX-MS Data Statistics
============================================================
States names: [&#39;APO&#39;, &#39;TRI&#39;]
Time course (s): [46.0, 373.5, 572.5, 2011.0, 7772.0, 30811.5, 43292.0]
Number of time points: 7
Protein sequence length: 174
Average coverage: 0.93
Number of unique peptides: 186
Average peptide length: 9.4
Redundancy (based on average coverage): 10.0
Average peptide length to redundancy ratio: 0.9
Backexchange average, IQR: 0.19, 0.15
============================================================
</pre></div></div>
</div>
</section>
<section id="back-exchange-correction">
<h2>back exchange correction<a class="headerlink" href="#back-exchange-correction" title="Link to this heading"></a></h2>
<p>back exchange correction for peptides with experimental full deuteration data based its closest match in the database</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tools</span><span class="o">.</span><span class="n">backexchange_correction</span><span class="p">(</span><span class="n">hdxms_data_list</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Number of peptides with experimental max_d: 358
Number of peptides with no experimental max_d: 12
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># grab all the peptides</span>

<span class="n">all_peps</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">pep</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">hdxms_data_list</span><span class="p">[:]</span>
    <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">states</span>
    <span class="k">for</span> <span class="n">pep</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">peptides</span>
<span class="p">]</span>

<span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">pep</span><span class="o">.</span><span class="n">identifier</span> <span class="k">for</span> <span class="n">pep</span> <span class="ow">in</span> <span class="n">all_peps</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
186
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">max_d</span> <span class="o">=</span> <span class="p">[</span><span class="n">pep</span><span class="o">.</span><span class="n">max_d</span> <span class="o">/</span> <span class="n">pep</span><span class="o">.</span><span class="n">theo_max_d</span> <span class="k">for</span> <span class="n">pep</span> <span class="ow">in</span> <span class="n">all_peps</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">max_d</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(array([18., 16., 10., 20., 30., 20., 42., 20., 24., 40., 38., 28., 20.,
        14.,  8.,  6.,  4.,  2.,  2.,  8.]),
 array([0.60127572, 0.62628601, 0.6512963 , 0.67630658, 0.70131687,
        0.72632716, 0.75133745, 0.77634774, 0.80135802, 0.82636831,
        0.8513786 , 0.87638889, 0.90139918, 0.92640947, 0.95141975,
        0.97643004, 1.00144033, 1.02645062, 1.05146091, 1.07647119,
        1.10148148]),
 &lt;BarContainer object of 20 artists&gt;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_00_ecdhfr_showcase_14_1.png" src="../_images/tutorials_00_ecdhfr_showcase_14_1.png" />
</div>
</div>
</section>
<section id="plot-uptake-plots">
<h2>plot uptake plots<a class="headerlink" href="#plot-uptake-plots" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># option 1</span>
<span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="kn">import</span> <span class="n">MultipleLocator</span><span class="p">,</span> <span class="n">FormatStrFormatter</span>
<span class="kn">import</span> <span class="nn">matplotlib.ticker</span> <span class="k">as</span> <span class="nn">ticker</span>
<span class="kn">import</span> <span class="nn">matplotlib.lines</span> <span class="k">as</span> <span class="nn">mlines</span>
<span class="kn">from</span> <span class="nn">pigeon_feather.analysis</span> <span class="kn">import</span> <span class="n">get_index_offset</span>
<span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="kn">import</span> <span class="n">LogLocator</span>


<span class="n">font</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;family&quot;</span><span class="p">:</span> <span class="s2">&quot;Arial&quot;</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">36</span><span class="p">}</span>
<span class="n">axes</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;titlesize&quot;</span><span class="p">:</span> <span class="mi">36</span><span class="p">,</span> <span class="s2">&quot;titleweight&quot;</span><span class="p">:</span> <span class="s2">&quot;bold&quot;</span><span class="p">,</span> <span class="s2">&quot;labelsize&quot;</span><span class="p">:</span> <span class="mi">36</span><span class="p">,</span> <span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">}</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s2">&quot;font&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">font</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s2">&quot;axes&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">axes</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;purple&quot;</span><span class="p">,</span> <span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="s2">&quot;yellow&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;brown&quot;</span><span class="p">]</span>


<span class="n">all_peps</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">peptide</span>
    <span class="k">for</span> <span class="n">hdxms_data</span> <span class="ow">in</span> <span class="n">hdxms_data_list</span>
    <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">hdxms_data</span><span class="o">.</span><span class="n">states</span>
    <span class="k">for</span> <span class="n">peptide</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">peptides</span>
    <span class="k">if</span> <span class="n">peptide</span><span class="o">.</span><span class="n">note</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">state</span><span class="o">.</span><span class="n">state_name</span> <span class="o">!=</span> <span class="s2">&quot;RAT&quot;</span>
<span class="p">]</span>
<span class="n">all_idfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">pep</span> <span class="k">for</span> <span class="n">pep</span> <span class="ow">in</span> <span class="n">all_peps</span> <span class="k">if</span> <span class="n">pep</span><span class="o">.</span><span class="n">unique_num_timepoints</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">]</span>
<span class="n">all_idfs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">peptide</span><span class="o">.</span><span class="n">identifier</span> <span class="k">for</span> <span class="n">peptide</span> <span class="ow">in</span> <span class="n">all_peps</span><span class="p">]))[:]</span>
<span class="n">all_idfs</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(-?\d+)&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">()))</span>



<span class="k">def</span> <span class="nf">idf_to_pep</span><span class="p">(</span><span class="n">idf</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">pep</span> <span class="k">for</span> <span class="n">pep</span> <span class="ow">in</span> <span class="n">all_peps</span> <span class="k">if</span> <span class="n">pep</span><span class="o">.</span><span class="n">identifier</span> <span class="o">==</span> <span class="n">idf</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># num_subplots_per_figure = 100</span>
<span class="n">num_subplots_per_figure</span> <span class="o">=</span> <span class="mi">250</span>
<span class="n">num_figures</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_idfs</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_subplots_per_figure</span><span class="p">)</span>


<span class="n">all_idfs_subset</span> <span class="o">=</span> <span class="n">all_idfs</span><span class="p">[:]</span>

<span class="k">for</span> <span class="n">fig_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_figures</span><span class="p">):</span>
    <span class="c1"># Select the subset of errors for the current figure</span>
    <span class="n">selected_idf</span> <span class="o">=</span> <span class="n">all_idfs_subset</span><span class="p">[</span>
        <span class="n">fig_index</span> <span class="o">*</span> <span class="n">num_subplots_per_figure</span> <span class="p">:</span> <span class="p">(</span><span class="n">fig_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">num_subplots_per_figure</span>
    <span class="p">]</span>
    <span class="n">num_col</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_idf</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
        <span class="n">num_col</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">num_col</span><span class="p">)</span>
    <span class="p">)</span>  <span class="c1"># Adjust subplot size as needed</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">idf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">selected_idf</span><span class="p">):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span> <span class="o">//</span> <span class="mi">5</span><span class="p">,</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">5</span><span class="p">]</span>


        <span class="n">pep</span> <span class="o">=</span> <span class="n">idf_to_pep</span><span class="p">(</span><span class="n">idf</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">pep</span><span class="o">.</span><span class="n">max_d</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>


        <span class="n">uptake</span> <span class="o">=</span> <span class="n">UptakePlot</span><span class="p">(</span>
            <span class="n">hdxms_data_list</span><span class="p">,</span>
            <span class="n">idf</span><span class="p">,</span>
            <span class="n">states_subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;APO&quot;</span><span class="p">,</span> <span class="s2">&quot;TRI&quot;</span><span class="p">],</span>
            <span class="n">if_plot_fit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mf">1e1</span><span class="p">,</span> <span class="mf">1e5</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">LogLocator</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">numticks</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>


        <span class="n">y_max</span> <span class="o">=</span> <span class="n">pep</span><span class="o">.</span><span class="n">theo_max_d</span><span class="o">/</span><span class="n">hdxms_data_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">saturation</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>


        <span class="c1">#Custom legend</span>
        <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
        <span class="n">new_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">label</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span> <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;APO&quot;</span><span class="p">,</span> <span class="s2">&quot;TRI&quot;</span><span class="p">]]</span>
        <span class="n">new_handles</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">handle</span>
            <span class="k">for</span> <span class="n">handle</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">handles</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;APO&quot;</span><span class="p">,</span> <span class="s2">&quot;TRI&quot;</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">new_handles</span><span class="p">,</span> <span class="n">new_labels</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="n">title_fontsize</span><span class="o">=</span><span class="s2">&quot;small&quot;</span><span class="p">,</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>


    <span class="c1"># Layout adjustment and save</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">results_path</span><span class="si">}</span><span class="s2">/DHFR_exp_uptake_</span><span class="si">{</span><span class="n">fig_index</span><span class="si">}</span><span class="s2">.pdf&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="peptide-subtraction">
<h2>peptide subtraction<a class="headerlink" href="#peptide-subtraction" title="Link to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># [state.add_all_subtract() for data in hdxms_data_list for state in data.states]</span>
<span class="c1"># add_new_peptides_by_subtract()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
    <span class="p">[</span>
        <span class="n">state</span><span class="o">.</span><span class="n">add_new_peptides_by_subtract</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">hdxms_data_list</span><span class="p">[:]</span>
        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">states</span>
    <span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
117 new peptides added to the APO state.
126 new peptides added to the TRI state.
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">state</span><span class="o">.</span><span class="n">num_subtracted_added</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">hdxms_data_list</span> <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">states</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[117, 126]
</pre></div></div>
</div>
<p>save the data as a pickle file for later use, and write to files used for bayesian sampling</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="n">out_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;./data/bayesian_hdx_input_</span><span class="si">{</span><span class="n">today</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">out_path</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">out_path</span><span class="p">)</span>


<span class="kn">import</span> <span class="nn">pickle</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">out_path</span><span class="si">}</span><span class="s2">/hdxms_data_list.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">hdxms_data_list</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

<span class="c1"># with open(f&quot;{out_path}/hdxms_data_list.pkl&quot;, &quot;rb&quot;) as f:</span>
<span class="c1">#     hdxms_data_list = pickle.load(f)</span>
</pre></div>
</div>
</div>
</section>
<section id="inputs-for-MCMC-sampling">
<h2>inputs for MCMC sampling<a class="headerlink" href="#inputs-for-MCMC-sampling" title="Link to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">exp_names</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;dhfr_tutorial_dataset&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hdxms_data_list</span><span class="p">)):</span>
    <span class="c1"># exp_name = raw_spectra_paths[i].split(&#39;/&#39;)[-2].split(&#39;SpecExport_&#39;)[-1]</span>
    <span class="n">exp_name</span> <span class="o">=</span> <span class="n">exp_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">export_iso_files</span><span class="p">(</span>
        <span class="n">hdxms_data_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">outdir</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">out_path</span><span class="si">}</span><span class="s2">/spectra_</span><span class="si">{</span><span class="n">exp_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">revert_hdxmsdata_to_dataframe</span><span class="p">(</span><span class="n">hdxms_data_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">convert_dataframe_to_bayesianhdx_format</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">protein_name</span><span class="o">=</span><span class="n">exp_name</span><span class="p">,</span> <span class="n">OUTPATH</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">out_path</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">exp_name</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Isotope files saved to ./data/bayesian_hdx_input_20240722/spectra_dhfr_tutorial_dataset
Reminder: sequence contains fastamides !!!
Reminder: sequence contains fastamides !!!
Data saved to ./data/bayesian_hdx_input_20240722
dhfr_tutorial_dataset
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># write ready to run script for each state</span>

<span class="n">protein_sequence</span> <span class="o">=</span> <span class="s2">&quot;MTGHHHHHHENLYFQSISLIAALAVDRVIGMENAMPWNLPADLAWFKRNTLDKPVIMGRHTWESIGRPLPGRKNIILSSQPGTDDRVTWVKSVDEAIAACGDVPEIMVIGGGRVYEQFLPKAQKLYLTHIDAEVEGDTHFPDYEPDDWESVFSEFHDADAQNSHSYCFEILERR&quot;</span>

<span class="n">state_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
    <span class="nb">set</span><span class="p">([</span><span class="n">state</span><span class="o">.</span><span class="n">state_name</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">hdxms_data_list</span> <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">states</span><span class="p">])</span>
<span class="p">)</span>
<span class="k">for</span> <span class="n">protein_state</span> <span class="ow">in</span> <span class="n">state_names</span><span class="p">:</span>
    <span class="n">script</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">generate_bayesian_hdx_script</span><span class="p">(</span>
        <span class="n">exp_names</span><span class="p">,</span>
        <span class="n">protein_sequence</span><span class="p">,</span>
        <span class="n">protein_state</span><span class="p">,</span>
        <span class="n">base_directory</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span>
        <span class="n">making_chunks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">pH</span><span class="o">=</span><span class="mf">7.0</span><span class="p">,</span>
        <span class="n">temperature</span><span class="o">=</span><span class="mf">293.0</span><span class="p">,</span>
        <span class="n">saturation</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
        <span class="n">rerun_num</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">extreme_value_prior</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">structural_prior</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">out_path</span><span class="si">}</span><span class="s2">/run_bayesian_hdx_</span><span class="si">{</span><span class="n">protein_state</span><span class="si">}</span><span class="s2">_chunks.py&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>
<br/><br/><br/></pre></div>
</div>
</div>
<p>two priors</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># uptake prior</span>
<span class="c1">#tools.generate_extreme_value_prior(hdxms_data_list, out_path)</span>


<span class="c1"># structural prior</span>

<span class="c1"># solvated_pdbs = [</span>
<span class="c1">#     &quot;./data/5DFR_APO_relaxed_best_solvated.pdb&quot;,</span>
<span class="c1">#     &quot;./data/6XG5_TRI_relaxed_best_solvated.pdb&quot;,</span>
<span class="c1">#     &quot;./data/1RG7_MTX_relaxed_best_solvated.pdb&quot;,</span>
<span class="c1"># ]</span>

<span class="c1"># for i, state_name in enumerate([&quot;APO&quot;, &quot;TRI&quot;, &quot;MTX&quot;]):</span>


<span class="c1">#     tools.generate_structural_prior(</span>
<span class="c1">#         protein_sequence, solvated_pdbs[i], out_path, state_name</span>
<span class="c1">#     )</span>
</pre></div>
</div>
</div>
</section>
<section id="run-the-sampling">
<h2>run the sampling<a class="headerlink" href="#run-the-sampling" title="Link to this heading"></a></h2>
<p>You can run the script in the terminal with the following command:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>./data/bayesian_hdx_input_20240722
python<span class="w"> </span>run_bayesian_hdx_APO_chunks.py
</pre></div>
</div>
<p>The simulations usually take several hours, but the duration varies based on the size of the dataset (number of peptides, time points, and replicates).</p>
</section>
<section id="Analysis">
<h2>Analysis<a class="headerlink" href="#Analysis" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pickle</span>

<span class="k">class</span> <span class="nc">CustomUnpickler</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">Unpickler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">find_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;ProteinState&quot;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">pigeon_feather.data</span> <span class="kn">import</span> <span class="n">ProteinState</span>

            <span class="k">return</span> <span class="n">ProteinState</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;HDXMSData&quot;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">pigeon_feather.data</span> <span class="kn">import</span> <span class="n">HDXMSData</span>

            <span class="k">return</span> <span class="n">HDXMSData</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;Peptide&quot;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">pigeon_feather.data</span> <span class="kn">import</span> <span class="n">Peptide</span>

            <span class="k">return</span> <span class="n">Peptide</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;Timepoint&quot;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">pigeon_feather.data</span> <span class="kn">import</span> <span class="n">Timepoint</span>

            <span class="k">return</span> <span class="n">Timepoint</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">find_class</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>


<span class="c1"># read pcikle</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">out_path</span><span class="si">}</span><span class="s2">/hdxms_data_list.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">hdxms_data_list</span> <span class="o">=</span> <span class="n">CustomUnpickler</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hdxms_data_list</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&lt;pigeon_feather.data.HDXMSData at 0x7f095a02d150&gt;]
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">hdxms_data_list</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">states</span><span class="p">:</span>
        <span class="n">state</span><span class="o">.</span><span class="n">peptides</span> <span class="o">=</span> <span class="p">[</span><span class="n">pep</span> <span class="k">for</span> <span class="n">pep</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">peptides</span> <span class="k">if</span> <span class="n">pep</span><span class="o">.</span><span class="n">note</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">pep</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">peptides</span><span class="p">:</span>
            <span class="n">pep</span><span class="o">.</span><span class="n">timepoints</span> <span class="o">=</span> <span class="p">[</span><span class="n">tp</span> <span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="n">pep</span><span class="o">.</span><span class="n">timepoints</span> <span class="k">if</span> <span class="n">tp</span><span class="o">.</span><span class="n">note</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>create an Analysis object and load the results, note: the temperature and pH are crucial to calculate the instrisic exchange rates. make sure to input the correct ones. The chunk size and chunk number can be altered by user. in this tutorial it was automaticaly determined by a help function.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pigeon_feather.analysis</span> <span class="kn">import</span> <span class="n">Analysis</span><span class="p">,</span> <span class="n">get_index_offset</span>
<span class="kn">from</span> <span class="nn">pigeon_feather.tools</span> <span class="kn">import</span> <span class="n">optimal_chunks</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">RUN_NUM</span> <span class="o">=</span> <span class="mi">3</span>

<span class="n">apo_states</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">state</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">hdxms_data_list</span>
    <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">states</span>
    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">state_name</span> <span class="o">==</span> <span class="s2">&quot;APO&quot;</span>
<span class="p">]</span>

<span class="n">tri_states</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">state</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">hdxms_data_list</span>
    <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">states</span>
    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">state_name</span> <span class="o">==</span> <span class="s2">&quot;TRI&quot;</span>
<span class="p">]</span>

<span class="n">ana_apo_1</span> <span class="o">=</span> <span class="n">Analysis</span><span class="p">(</span><span class="n">apo_states</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">293.0</span><span class="p">,</span> <span class="n">pH</span><span class="o">=</span><span class="mf">7.0</span><span class="p">)</span>

<span class="n">chunk_num</span><span class="p">,</span> <span class="n">chunk_size</span> <span class="o">=</span> <span class="n">optimal_chunks</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ana_apo_1</span><span class="o">.</span><span class="n">protein_sequence</span><span class="p">))</span>
<span class="n">ana_apo_1</span><span class="o">.</span><span class="n">load_bayesian_hdx_oupt_chunks</span><span class="p">(</span>
    <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">,</span>
    <span class="n">chunk_num</span><span class="o">=</span><span class="n">chunk_num</span><span class="p">,</span>
    <span class="n">state_name</span><span class="o">=</span><span class="s2">&quot;APO&quot;</span><span class="p">,</span>
    <span class="n">run_num</span><span class="o">=</span><span class="n">RUN_NUM</span><span class="p">,</span>
    <span class="n">N</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
    <span class="n">bayesian_hdx_data_folder</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">out_path</span><span class="si">}</span><span class="s2">/bayesian_hdx_output_chunks&quot;</span><span class="p">,</span>
<span class="p">)</span>


<span class="n">ana_tri_1</span> <span class="o">=</span> <span class="n">Analysis</span><span class="p">(</span><span class="n">tri_states</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">293.0</span><span class="p">,</span> <span class="n">pH</span><span class="o">=</span><span class="mf">7.0</span><span class="p">)</span>

<span class="n">ana_tri_1</span><span class="o">.</span><span class="n">load_bayesian_hdx_oupt_chunks</span><span class="p">(</span>
    <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">,</span>
    <span class="n">chunk_num</span><span class="o">=</span><span class="n">chunk_num</span><span class="p">,</span>
    <span class="n">state_name</span><span class="o">=</span><span class="s2">&quot;TRI&quot;</span><span class="p">,</span>
    <span class="n">run_num</span><span class="o">=</span><span class="n">RUN_NUM</span><span class="p">,</span>
    <span class="n">N</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
    <span class="n">bayesian_hdx_data_folder</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">out_path</span><span class="si">}</span><span class="s2">/bayesian_hdx_output_chunks&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># for mini in ana_apo_1.results_obj.mini_peps:</span>
<span class="c1">#     print(mini.std_within_clusters_log_kex)</span>
</pre></div>
</div>
</div>
</section>
<section id="Fitting-check">
<h2>Fitting check<a class="headerlink" href="#Fitting-check" title="Link to this heading"></a></h2>
<p>two fitting check functions are available: 1. centroid level fitting check 2. isotopic mass envelope fitting check.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pigeon_feather.analysis</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">check_fitted_isotope_envelope</span><span class="p">,</span>
    <span class="n">check_fitted_peptide_uptake</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<section id="envelope-check">
<h3>envelope check<a class="headerlink" href="#envelope-check" title="Link to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">check_state_name</span> <span class="o">=</span> <span class="s2">&quot;APO&quot;</span>
<span class="n">check_ana_obj</span> <span class="o">=</span> <span class="n">ana_apo_1</span>


<span class="n">all_peps</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">pep</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">hdxms_data_list</span>
    <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">states</span>
    <span class="k">for</span> <span class="n">pep</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">peptides</span>
    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">state_name</span> <span class="o">==</span> <span class="n">check_state_name</span> <span class="ow">and</span> <span class="n">pep</span><span class="o">.</span><span class="n">note</span> <span class="ow">is</span> <span class="kc">None</span>
<span class="p">]</span>
<span class="n">all_tps</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">tp</span>
    <span class="k">for</span> <span class="n">pep</span> <span class="ow">in</span> <span class="n">all_peps</span>
    <span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="n">pep</span><span class="o">.</span><span class="n">timepoints</span>
    <span class="k">if</span> <span class="n">pep</span><span class="o">.</span><span class="n">get_timepoint</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tp</span><span class="o">.</span><span class="n">deut_time</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="ow">and</span> <span class="n">tp</span><span class="o">.</span><span class="n">deut_time</span> <span class="o">!=</span> <span class="mi">0</span>
<span class="p">]</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">envelope_errors</span> <span class="o">=</span> <span class="p">[(</span><span class="n">check_fitted_isotope_envelope</span><span class="p">(</span><span class="n">ana_apo_1</span><span class="p">,</span> <span class="n">tp</span><span class="p">),</span> <span class="n">tp</span><span class="p">)</span> <span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="n">all_tps</span><span class="p">]</span>
<span class="n">envelope_errors</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">envelope_errors</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># you can plot the fitted isotope envelope and the experimental data</span>
<span class="n">check_fitted_isotope_envelope</span><span class="p">(</span><span class="n">check_ana_obj</span><span class="p">,</span> <span class="n">envelope_errors</span><span class="p">[</span><span class="mi">300</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">if_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0.18086398727111275
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_00_ecdhfr_showcase_41_1.png" src="../_images/tutorials_00_ecdhfr_showcase_41_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">envelope_errors</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Sum AE&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Count&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0, 0.5, &#39;Count&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_00_ecdhfr_showcase_42_1.png" src="../_images/tutorials_00_ecdhfr_showcase_42_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><span></span><span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">envelope_errors</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">envelope_errors</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0.3646019382844139
0.39348193324578395
</pre></div></div>
</div>
</section>
<section id="uptake-check">
<h3>uptake check<a class="headerlink" href="#uptake-check" title="Link to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pigeon_feather.analysis</span> <span class="kn">import</span> <span class="n">check_fitted_peptide_uptake</span>


<span class="n">all_idfs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">pep</span><span class="o">.</span><span class="n">identifier</span> <span class="k">for</span> <span class="n">pep</span> <span class="ow">in</span> <span class="n">all_peps</span><span class="p">]))</span>


<span class="k">def</span> <span class="nf">extract_numbers</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="n">numbers</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(-?\d+)-(-?\d+)&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">numbers</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>


<span class="n">all_idfs</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">extract_numbers</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">uptake_errors</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">all_peps_grouped</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">group_by_attributes</span><span class="p">(</span>
    <span class="n">all_peps</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;protein_state.state_name&quot;</span><span class="p">,</span> <span class="s2">&quot;identifier&quot;</span><span class="p">]</span>
<span class="p">)</span>

<span class="k">for</span> <span class="n">idf</span> <span class="ow">in</span> <span class="n">all_idfs</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">idf_peps</span> <span class="o">=</span> <span class="n">all_peps_grouped</span><span class="p">[(</span><span class="n">check_state_name</span><span class="p">,</span> <span class="n">idf</span><span class="p">)]</span>
        <span class="n">avg_pep</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">average_peptides</span><span class="p">(</span><span class="n">idf_peps</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">check_fitted_peptide_uptake</span><span class="p">(</span>
            <span class="n">check_ana_obj</span><span class="p">,</span> <span class="n">hdxms_data_list</span><span class="p">,</span> <span class="n">avg_pep</span><span class="p">,</span> <span class="n">state_name</span><span class="o">=</span><span class="n">check_state_name</span>
        <span class="p">)</span>
        <span class="n">uptake_errors</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">result</span><span class="p">,</span> <span class="n">avg_pep</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">idf</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>


<span class="n">uptake_errors_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">uptake_errors</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>


<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">))</span>

<span class="c1"># # Plotting with complementary colors</span>
<span class="c1"># sns.histplot([x[0] for x in envelope_errors], bins=20, kde=True, ax=axes[0], color=&quot;#FF6347&quot;)</span>
<span class="c1"># sns.histplot(uptake_errors_array, bins=20, kde=True, ax=axes[1], color=&quot;#4682B4&quot;)</span>


<span class="n">color_1</span> <span class="o">=</span> <span class="s2">&quot;#53b1b1&quot;</span>  <span class="c1"># A standard blue color</span>
<span class="n">color_2</span> <span class="o">=</span> <span class="s2">&quot;#f6c624&quot;</span>  <span class="c1"># A teal color</span>

<span class="c1"># Plotting with chosen colors</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">envelope_errors</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color_1</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">uptake_errors_array</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color_2</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Sum AE&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Da/peptide length&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_00_ecdhfr_showcase_47_0.png" src="../_images/tutorials_00_ecdhfr_showcase_47_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pigeon_feather.analysis</span> <span class="kn">import</span> <span class="n">get_index_offset</span>
<span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="kn">import</span> <span class="n">LogLocator</span>


<span class="n">check_ana_obj</span> <span class="o">=</span> <span class="n">ana_apo_1</span>
<span class="n">index_offset</span> <span class="o">=</span> <span class="n">get_index_offset</span><span class="p">(</span><span class="n">check_ana_obj</span><span class="p">,</span> <span class="s1">&#39;./data/6XG5_TRI.pdb&#39;</span><span class="p">)</span>

<span class="n">uptake_errors</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">uptake_errors</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">num_subplots_per_figure</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">uptake_errors</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="c1"># num_subplots_per_figure = 250</span>
<span class="n">num_figures</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_idfs</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_subplots_per_figure</span><span class="p">)</span>


<span class="k">for</span> <span class="n">fig_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_figures</span><span class="p">):</span>
    <span class="c1"># Select the subset of errors for the current figure</span>
    <span class="n">selected_uptake_errors</span> <span class="o">=</span> <span class="n">uptake_errors</span><span class="p">[</span><span class="n">fig_index</span> <span class="o">*</span> <span class="n">num_subplots_per_figure</span><span class="p">:(</span><span class="n">fig_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">num_subplots_per_figure</span><span class="p">]</span>
    <span class="n">num_col</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_uptake_errors</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">num_col</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">num_col</span><span class="p">))</span>  <span class="c1"># Adjust subplot size as needed</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">error_tuple</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">selected_uptake_errors</span><span class="p">):</span>


        <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span> <span class="o">//</span> <span class="mi">5</span><span class="p">,</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">5</span><span class="p">]</span>


        <span class="c1"># Unpack error information</span>
        <span class="n">peptide_data</span> <span class="o">=</span> <span class="n">error_tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>


        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">peptide_data</span><span class="o">.</span><span class="n">max_d</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="n">check_fitted_peptide_uptake</span><span class="p">(</span>
            <span class="n">check_ana_obj</span><span class="p">,</span>
            <span class="n">hdxms_data_list</span><span class="p">,</span>
            <span class="n">peptide_data</span><span class="p">,</span>
            <span class="n">if_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">state_name</span><span class="o">=</span><span class="n">check_state_name</span><span class="p">,</span>
            <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span>
        <span class="p">)</span>

        <span class="c1">#Retrieve and format the peptide identifier</span>
        <span class="n">idf</span> <span class="o">=</span> <span class="n">peptide_data</span><span class="o">.</span><span class="n">identifier</span>
        <span class="n">idf_start</span><span class="p">,</span> <span class="n">idf_end</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(-?\d+)-(-?\d+)&quot;</span><span class="p">,</span> <span class="n">idf</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">())</span>
        <span class="n">idf_seq</span> <span class="o">=</span> <span class="n">idf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idf_start</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">index_offset</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">idf_end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">index_offset</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">idf_seq</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mf">1e1</span><span class="p">,</span> <span class="mf">1e5</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">LogLocator</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">numticks</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>

        <span class="c1"># y_max = ax.get_ylim()[1]</span>
        <span class="c1"># ax.set_ylim(-0.5, y_max + 1)</span>
        <span class="n">pep</span> <span class="o">=</span> <span class="n">error_tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">y_max</span> <span class="o">=</span> <span class="n">pep</span><span class="o">.</span><span class="n">theo_max_d</span><span class="o">/</span><span class="n">check_ana_obj</span><span class="o">.</span><span class="n">saturation</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>

        <span class="c1"># light gray dotted line at max deuteration</span>


        <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
        <span class="n">new_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">label</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span> <span class="k">if</span> <span class="n">label</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()]</span>
        <span class="n">new_handles</span> <span class="o">=</span> <span class="p">[</span><span class="n">handle</span> <span class="k">for</span> <span class="n">handle</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">handles</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span> <span class="k">if</span> <span class="n">label</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">new_handles</span><span class="p">,</span> <span class="n">new_labels</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;replicate&#39;</span><span class="p">,</span> <span class="n">title_fontsize</span><span class="o">=</span><span class="s1">&#39;small&#39;</span><span class="p">)</span>

    <span class="c1"># Layout adjustment and save</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">results_path</span><span class="si">}</span><span class="s2">/ecDHFR_uptake_errors_</span><span class="si">{</span><span class="n">check_state_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">fig_index</span><span class="si">}</span><span class="s2">.pdf&quot;</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<p>if the fitting is bad, one should not move forward, need to check the parameters in the sampling, make sure they agree with the experimental conditions. one may also remove the outlier peptides and run the all the cells above again. a ourliter may be a peptide exchange a lot while its neighbours barely exchange (examples in the turtorial dataset: 78-92 VDEAIAACGDVPEIM, 75-78 VKSV)</p>
<p>once you’re satisfied with the fitting results, you can make the final results plots</p>
</section>
</section>
<section id="barplot-of-the-kex">
<h2>barplot of the kex<a class="headerlink" href="#barplot-of-the-kex" title="Link to this heading"></a></h2>
<p>barplot showing the FEATHER derived exchange rates. index_offset is determined by comparison to the sequence in HX/MS and the pdb file provided.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># APO state only</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">ana_apo_1</span><span class="o">.</span><span class="n">plot_kex_bar</span><span class="p">(</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">resolution_indicator_pos</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;APO&quot;</span><span class="p">,</span> <span class="n">show_seq</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span>
<span class="p">)</span>

<span class="n">ana_tri_1</span><span class="o">.</span><span class="n">plot_kex_bar</span><span class="p">(</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">resolution_indicator_pos</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;TRI&quot;</span><span class="p">,</span> <span class="n">show_seq</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">import</span> <span class="n">step</span>
<span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="kn">import</span> <span class="n">FuncFormatter</span><span class="p">,</span> <span class="n">MultipleLocator</span>

<span class="kn">from</span> <span class="nn">pigeon_feather.analysis</span> <span class="kn">import</span> <span class="n">get_index_offset</span>

<span class="n">pdb_file</span> <span class="o">=</span> <span class="s2">&quot;./data/6XG5_TRI.pdb&quot;</span>
<span class="n">index_offset</span> <span class="o">=</span> <span class="n">get_index_offset</span><span class="p">(</span><span class="n">ana_apo_1</span><span class="p">,</span> <span class="n">pdb_file</span><span class="p">)</span>

<span class="c1"># # ax.xaxis.set_major_locator(plt.MultipleLocator(2))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_xticks</span><span class="p">()[::</span><span class="mi">2</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fontsize&quot;</span><span class="p">:</span> <span class="mi">24</span><span class="p">})</span>


<span class="k">def</span> <span class="nf">format_func</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">tick_number</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">index_offset</span><span class="w"> </span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">FuncFormatter</span><span class="p">(</span><span class="n">format_func</span><span class="p">))</span>

<span class="n">seq_pos</span> <span class="o">=</span> <span class="mi">17</span>
<span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ana_apo_1</span><span class="o">.</span><span class="n">protein_sequence</span><span class="p">[:]),</span> <span class="mi">2</span><span class="p">):</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="n">ii</span><span class="p">,</span>
        <span class="n">seq_pos</span><span class="p">,</span>
        <span class="n">ana_apo_1</span><span class="o">.</span><span class="n">protein_sequence</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
        <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
        <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
        <span class="n">fontsize</span><span class="o">=</span><span class="mi">22</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;-log(k$_</span><span class="si">{ex}</span><span class="s2">$)&quot;</span><span class="p">)</span>
    <span class="c1">#ax.legend(loc=&quot;lower left&quot;)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ana_apo_1</span><span class="o">.</span><span class="n">protein_sequence</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span>
        <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ana_apo_1</span><span class="o">.</span><span class="n">protein_sequence</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">],</span>
        <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span>
        <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.08</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">results_path</span><span class="si">}</span><span class="s2">/ecDHFR_kex_bar_APO_TRI_</span><span class="si">{</span><span class="n">today_date</span><span class="si">}</span><span class="s2">.pdf&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_00_ecdhfr_showcase_53_0.png" src="../_images/tutorials_00_ecdhfr_showcase_53_0.png" />
</div>
</div>
<p>logP projection to a pdb structure</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pigeon_feather.analysis</span> <span class="kn">import</span> <span class="n">BFactorPlot</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bfactor_plot</span> <span class="o">=</span> <span class="n">BFactorPlot</span><span class="p">(</span>
    <span class="n">ana_apo_1</span><span class="p">,</span>
    <span class="n">pdb_file</span><span class="o">=</span><span class="s2">&quot;./data/6XG5_TRI.pdb&quot;</span><span class="p">,</span>
    <span class="n">plot_deltaG</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">temperature</span><span class="o">=</span><span class="mf">293.15</span><span class="p">,</span>
    <span class="n">logP_threshold</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">bfactor_plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">results_path</span><span class="si">}</span><span class="s2">/6XG5_APO_deltaG.pdb&quot;</span><span class="p">)</span>

<span class="c1"># bfactor_plot = BFactorPlot(</span>
<span class="c1">#     ana_apo_1,</span>
<span class="c1">#     pdb_file=&quot;./data/6XG5_APO_relaxed_best_solvated.pdb&quot;,</span>
<span class="c1">#     plot_deltaG=True,</span>
<span class="c1">#     temperature=293.15,</span>
<span class="c1"># )</span>
<span class="c1"># bfactor_plot.plot(f&quot;{out_path}/6XG5_APO_deltaG.pdb&quot;)</span>
</pre></div>
</div>
</div>
<p>delta logP</p>
<p>if there are mutiple states availble, one can map the difference to the pdb strutcure</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bfactor_plot</span> <span class="o">=</span> <span class="n">BFactorPlot</span><span class="p">(</span>
    <span class="n">ana_apo_1</span><span class="p">,</span>
    <span class="n">ana_tri_1</span><span class="p">,</span>
    <span class="n">pdb_file</span><span class="o">=</span><span class="s2">&quot;./data/6XG5_TRI.pdb&quot;</span><span class="p">,</span>
    <span class="n">plot_deltaG</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">temperature</span><span class="o">=</span><span class="mf">293.15</span><span class="p">,</span>
    <span class="n">logP_threshold</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">bfactor_plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">results_path</span><span class="si">}</span><span class="s2">/6XG5_deltaG_APO-TRI.pdb&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>export logPFs to a csv</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">MDAnalysis</span>
<span class="kn">from</span> <span class="nn">pigeon_feather.analysis</span> <span class="kn">import</span> <span class="n">get_res_avg_logP</span><span class="p">,</span> <span class="n">get_res_avg_logP_std</span>

<span class="n">pdb_file</span> <span class="o">=</span> <span class="s2">&quot;./data/6XG5_TRI.pdb&quot;</span>
<span class="n">index_offset</span> <span class="o">=</span> <span class="n">get_index_offset</span><span class="p">(</span><span class="n">ana_apo_1</span><span class="p">,</span> <span class="n">pdb_file</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">logPF_to_deltaG</span><span class="p">(</span><span class="n">ana_obj</span><span class="p">,</span> <span class="n">logPF</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param logPF: logP value</span>
<span class="sd">    :return: deltaG in kJ/mol, local unfolding energy</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="mf">8.3145</span> <span class="o">*</span> <span class="n">ana_obj</span><span class="o">.</span><span class="n">temperature</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="n">logPF</span> <span class="o">/</span> <span class="mi">1000</span>


<span class="k">def</span> <span class="nf">create_logP_df</span><span class="p">(</span><span class="n">ana_obj</span><span class="p">,</span> <span class="n">index_offset</span><span class="p">):</span>
    <span class="n">df_logPF</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">res_i</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ana_obj</span><span class="o">.</span><span class="n">results_obj</span><span class="o">.</span><span class="n">protein_sequence</span><span class="p">):</span>
        <span class="n">res_obj_i</span> <span class="o">=</span> <span class="n">ana_obj</span><span class="o">.</span><span class="n">results_obj</span><span class="o">.</span><span class="n">get_residue_by_resindex</span><span class="p">(</span><span class="n">res_i</span><span class="p">)</span>

        <span class="n">avg_logP</span><span class="p">,</span> <span class="n">std_logP</span> <span class="o">=</span> <span class="n">get_res_avg_logP</span><span class="p">(</span><span class="n">res_obj_i</span><span class="p">)</span>
        <span class="c1">#std_logP = get_res_avg_logP_std(res_obj_i)</span>

        <span class="n">df_i</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;resid&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">res_obj_i</span><span class="o">.</span><span class="n">resid</span> <span class="o">-</span> <span class="n">index_offset</span><span class="p">],</span>
                <span class="c1">#&quot;resname&quot;: [res_obj_i.resname],</span>
                <span class="s2">&quot;resname&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">MDAnalysis</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">convert_aa_code</span><span class="p">(</span><span class="n">res_obj_i</span><span class="o">.</span><span class="n">resname</span><span class="p">)],</span>
                <span class="s1">&#39;avg_dG&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">logPF_to_deltaG</span><span class="p">(</span><span class="n">ana_obj</span><span class="p">,</span> <span class="n">avg_logP</span><span class="p">)],</span>
                <span class="s1">&#39;std_dG&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">logPF_to_deltaG</span><span class="p">(</span><span class="n">ana_obj</span><span class="p">,</span> <span class="n">std_logP</span><span class="p">)],</span>
                <span class="s2">&quot;avg_logP&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">avg_logP</span><span class="p">],</span>
                <span class="s2">&quot;std_logP&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">std_logP</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">)],</span>
                <span class="s2">&quot;is_nan&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">res_obj_i</span><span class="o">.</span><span class="n">is_nan</span><span class="p">()],</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">res_obj_i</span><span class="o">.</span><span class="n">is_nan</span><span class="p">():</span>
            <span class="n">df_i</span><span class="p">[</span><span class="s2">&quot;single resloved&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span>
            <span class="n">df_i</span><span class="p">[</span><span class="s2">&quot;min_pep logPs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">df_i</span><span class="p">[</span><span class="s2">&quot;single resloved&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">res_obj_i</span><span class="o">.</span><span class="n">mini_pep</span><span class="o">.</span><span class="n">if_single_residue</span><span class="p">()]</span>
            <span class="n">df_i</span><span class="p">[</span><span class="s2">&quot;min_pep logPs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">res_obj_i</span><span class="o">.</span><span class="n">clustering_results_logP</span><span class="p">]</span>

        <span class="n">df_logPF</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_logPF</span><span class="p">,</span> <span class="n">df_i</span><span class="p">])</span>

    <span class="n">df_logPF</span> <span class="o">=</span> <span class="n">df_logPF</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_logPF</span>


<span class="n">df</span> <span class="o">=</span> <span class="n">create_logP_df</span><span class="p">(</span><span class="n">ana_apo_1</span><span class="p">,</span> <span class="n">index_offset</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">results_path</span><span class="si">}</span><span class="s2">/logP_APO_</span><span class="si">{</span><span class="n">today_date</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># fecth two df and merge</span>
<span class="n">df_apo</span> <span class="o">=</span> <span class="n">create_logP_df</span><span class="p">(</span><span class="n">ana_apo_1</span><span class="p">,</span> <span class="n">index_offset</span><span class="p">)</span>
<span class="n">df_tri</span> <span class="o">=</span> <span class="n">create_logP_df</span><span class="p">(</span><span class="n">ana_tri_1</span><span class="p">,</span> <span class="n">index_offset</span><span class="p">)</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_apo</span><span class="p">,</span> <span class="n">df_tri</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;resid&quot;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;_APO&quot;</span><span class="p">,</span> <span class="s2">&quot;_TRI&quot;</span><span class="p">))</span>

<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">results_path</span><span class="si">}</span><span class="s2">/logP_APO_TRI_</span><span class="si">{</span><span class="n">today_date</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../tutorial.html" class="btn btn-neutral float-left" title="Tutorials" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="01_load_data.html" class="btn btn-neutral float-right" title="01_load_data" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, glasgowlab.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>